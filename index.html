<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Stendhal Formatter</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        gap: 16px;
        padding: 20px;
        font-family: sans-serif;
      }

      textarea,
      input,
      button {
        width: 100%;
        box-sizing: border-box;
        font-size: 14px;
        padding: 8px;
      }

      .column {
        border: 3px solid black;
        padding: 10px;
        width: 30%;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .center-column {
        width: 10%;
        display: flex;
        flex-direction: column;
        gap: 8px;
        justify-content: flex-start;
        align-items: stretch;
      }

      label {
        font-weight: bold;
      }

      #stendhalText {
        resize: none;
        height: 100%;
        min-height: 600px;
      }
    </style>
  </head>
  <body>
    <div class="column">
      <label>–û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç</label>
      <textarea id="plainText" rows="30"></textarea>
    </div>

    <div class="center-column">
      <label for="title">–¢–∞–π—Ç–ª</label>
      <input id="title" type="text" placeholder="–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" />
      <label for="author">–ê–≤—Ç–æ—Ä</label>
      <input id="author" type="text" placeholder="–ê–Ω–æ–Ω–∏–º" />
      <button id="downloadBtn">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
    </div>

    <div class="column">
      <label>Stendhal —Ñ–æ—Ä–º–∞—Ç</label>
      <textarea id="stendhalText" disabled></textarea>
    </div>

    <script>
      const plainText = document.getElementById('plainText')
      const titleInput = document.getElementById('title')
      const authorInput = document.getElementById('author')
      const stendhalText = document.getElementById('stendhalText')
      const downloadBtn = document.getElementById('downloadBtn')

      // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–∑–±–∏–≤–∞–µ—Ç –æ–¥–∏–Ω –ø–∞—Ä–∞–≥—Ä–∞—Ñ –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –¥–ª–∏–Ω–æ–π –Ω–µ –±–æ–ª–µ–µ maxCharsPerGroup
      function wrapParagraph(paragraph, maxCharsPerGroup = 28) {
        // –†–∞–∑–±–∏–≤–∞–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–±–µ–ª–æ–≤ (–∫–∞–∂–¥—ã–π —Ç–æ–∫–µ–Ω ‚Äì —Å–ª–æ–≤–æ + –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–±–µ–ª—ã)
        const tokens = paragraph.match(/\S+\s*/g) || []
        let lines = []
        let currentLine = ''

        for (let token of tokens) {
          // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç ‚Äì –¥–æ–±–∞–≤–ª—è–µ–º
          if ((currentLine + token).length <= maxCharsPerGroup) {
            currentLine += token
          } else {
            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–µ –ø—É—Å—Ç–∞ ‚Äì —Ñ–∏–∫—Å–∏—Ä—É–µ–º –µ—ë
            if (currentLine.trim().length > 0) {
              lines.push(currentLine.trimEnd())
            }
            // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É —Å —Ç–µ–∫—É—â–µ–≥–æ —Ç–æ–∫–µ–Ω–∞
            currentLine = token
            // –ï—Å–ª–∏ —Å–ª–æ–≤–æ —Å–∞–º–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç ‚Äì –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–º–µ—â–∞–µ–º –µ–≥–æ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É (–±–µ–∑ —Ä–∞–∑–±–∏–µ–Ω–∏—è)
            if (currentLine.length > maxCharsPerGroup) {
              lines.push(currentLine)
              currentLine = ''
            }
          }
        }
        if (currentLine.trim().length > 0) {
          lines.push(currentLine.trimEnd())
        }
        return lines
      }

      // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–∞–Ω–∏—Ü —Å —É—á—ë—Ç–æ–º:
      // - –Ω–µ –±–æ–ª–µ–µ 256 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ,
      // - –Ω–µ –±–æ–ª–µ–µ 14 —Å—Ç—Ä–æ–∫ (–≥—Ä—É–ø–ø) –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –∫–∞–∂–¥–∞—è –Ω–µ –¥–ª–∏–Ω–Ω–µ–µ 28 —Å–∏–º–≤–æ–ª–æ–≤,
      // - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ –∏ –æ—Ç—Å—Ç—É–ø–æ–≤.
      function splitTextToPagesStendhal(
        text,
        maxCharsPage = 256,
        maxGroupsPerPage = 14,
        maxCharsPerGroup = 28
      ) {
        // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ "–ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã" –ø–æ —Å–∏–º–≤–æ–ª—É –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç—Ä–æ–∫–∏
        const rawParagraphs = text.split('\n')
        let stendhalLines = []

        for (let para of rawParagraphs) {
          if (para.trim() === '') {
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è ‚Äì —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—ë –∫–∞–∫ –ø—É—Å—Ç—É—é –≥—Ä—É–ø–ø—É
            stendhalLines.push('')
          } else {
            // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏—Å—Ö–æ–¥–Ω–æ–≥–æ whitespace
            const wrappedLines = wrapParagraph(para, maxCharsPerGroup)
            stendhalLines = stendhalLines.concat(wrappedLines)
          }
        }

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å—Ç—Ä–æ–∫ –∏ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–∏–º–≤–æ–ª–æ–≤
        let pages = []
        let currentPageLines = []

        for (let line of stendhalLines) {
          let prospectiveLines = currentPageLines.concat(line)
          let pageText = prospectiveLines.join('\n')
          if (
            prospectiveLines.length > maxGroupsPerPage ||
            pageText.length > maxCharsPage
          ) {
            if (currentPageLines.length > 0) {
              pages.push(currentPageLines.join('\n'))
            }
            currentPageLines = [line]
          } else {
            currentPageLines.push(line)
          }
        }
        if (currentPageLines.length > 0) {
          pages.push(currentPageLines.join('\n'))
        }
        return pages
      }

      function generateStendhalFormat() {
        const title = titleInput.value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'
        const author = authorInput.value.trim() || '–ê–Ω–æ–Ω–∏–º'
        const text = plainText.value

        const pages = splitTextToPagesStendhal(text)
        const formattedPages = pages.map((p) => `#- ${p}`).join('\n')

        return `title: ${title}\nauthor: ${author}\npages:\n${formattedPages}`
      }

      function updateOutput() {
        const formatted = generateStendhalFormat()
        stendhalText.value = formatted
      }

      function downloadFile() {
        const title = titleInput.value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'
        const blob = new Blob([generateStendhalFormat()], {
          type: 'text/plain;charset=utf-8',
        })
        const url = URL.createObjectURL(blob)
        const link = document.createElement('a')
        link.href = url
        link.download = `${title}.stendhal`
        link.click()
        URL.revokeObjectURL(url)
      }

      plainText.addEventListener('input', updateOutput)
      titleInput.addEventListener('input', updateOutput)
      authorInput.addEventListener('input', updateOutput)
      downloadBtn.addEventListener('click', downloadFile)

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      updateOutput()
    </script>
  </body>
</html>
