<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Stendhal Formatter</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        gap: 16px;
        padding: 20px;
        font-family: sans-serif;
      }

      textarea,
      input,
      button {
        width: 100%;
        box-sizing: border-box;
        font-size: 14px;
        padding: 8px;
      }

      .column {
        border: 3px solid black;
        padding: 10px;
        width: 30%;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .center-column {
        width: 10%;
        display: flex;
        flex-direction: column;
        gap: 8px;
        justify-content: flex-start;
        align-items: stretch;
      }

      label {
        font-weight: bold;
      }

      #stendhalText {
        resize: none;
        height: 100%;
        min-height: 600px;
      }
    </style>
  </head>
  <body>
    <div class="column">
      <label>–û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç</label>
      <textarea id="plainText" rows="30"></textarea>
    </div>

    <div class="center-column">
      <label for="title">–¢–∞–π—Ç–ª</label>
      <input id="title" type="text" placeholder="–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" />
      <label for="author">–ê–≤—Ç–æ—Ä</label>
      <input id="author" type="text" placeholder="–ê–Ω–æ–Ω–∏–º" />
      <button id="downloadBtn">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
    </div>

    <div class="column">
      <label>Stendhal —Ñ–æ—Ä–º–∞—Ç</label>
      <textarea id="stendhalText" disabled></textarea>
    </div>

    <script>
      const plainText = document.getElementById('plainText')
      const titleInput = document.getElementById('title')
      const authorInput = document.getElementById('author')
      const stendhalText = document.getElementById('stendhalText')
      const downloadBtn = document.getElementById('downloadBtn')

      function splitTextToPagesPreserveWhitespace(text, maxLen = 256) {
        const lines = text.replace(/\r\n/g, '\n').split('\n')
        const pages = []
        let currentPage = ''

        for (let line of lines) {
          if (line === '') {
            line = '\n' // –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ = –ø–µ—Ä–µ–Ω–æ—Å
          } else {
            line += '\n' // –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ –Ω–µ–ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫
          }

          const currentLines = currentPage.split('\n').length
          const incomingLines = line.split('\n').length
          if (
            (currentPage + line).length <= maxLen &&
            currentLines + incomingLines - 1 <= 14
          ) {
            currentPage += line
          } else {
            if (currentPage.trim()) pages.push(currentPage.trimEnd())
            currentPage = ''

            if (line.length <= maxLen) {
              currentPage = line
            } else {
              // —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –Ω—É–∂–Ω–æ —Ä–∞–∑–±–∏—Ç—å –ø–æ —Å–ª–æ–≤–∞–º
              const words = line.trimEnd().split(/(\s+)/) // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ —Ç–∞–±—ã
              let subline = ''
              for (let w of words) {
                if ((subline + w).length > maxLen) {
                  pages.push(subline.trimEnd())
                  subline = w
                } else {
                  subline += w
                }
              }
              if (subline.trim()) {
                currentPage = subline + '\n'
              }
            }
          }
        }

        if (currentPage.trim()) {
          pages.push(currentPage.trimEnd())
        }

        return pages
      }

      function generateStendhalFormat() {
        const title = titleInput.value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'
        const author = authorInput.value.trim() || '–ê–Ω–æ–Ω–∏–º'
        const text = plainText.value

        const pages = splitTextToPagesPreserveWhitespace(text, 220)
        const formattedPages = pages.map((p) => `#- ${p}`).join('\n')

        return `title: ${title}\nauthor: ${author}\npages:\n${formattedPages}`
      }

      function updateOutput() {
        const formatted = generateStendhalFormat()
        stendhalText.value = formatted
      }

      function downloadFile() {
        const title = titleInput.value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'
        const blob = new Blob([generateStendhalFormat()], {
          type: 'text/plain;charset=utf-8',
        })
        const url = URL.createObjectURL(blob)
        const link = document.createElement('a')
        link.href = url
        link.download = `${title}.stendhal`
        link.click()
        URL.revokeObjectURL(url)
      }

      plainText.addEventListener('input', updateOutput)
      titleInput.addEventListener('input', updateOutput)
      authorInput.addEventListener('input', updateOutput)
      downloadBtn.addEventListener('click', downloadFile)

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      updateOutput()
    </script>
  </body>
</html>
